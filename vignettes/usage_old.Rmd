---
author: "D. Puthier & Jessica Chevalier."
date: "`r Sys.Date()`"
title: "Guided tutorial"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEngine{knitr::knitr}
  %\VignetteIndexEntry{Guided tutorial}
  %\usepackage[UTF-8]{inputenc}
---

# Jessica's dataset (Merscope)

```{r verbosity_level, echo = TRUE, eval=TRUE, warning=FALSE, results='hide'}
library(stcompr)
library(ggplot2)
library(patchwork)
stcompr::set_verbosity(3)
```

## Loading the dataset

Some text about the `load_spatial()` function.

```{r load_dataset, echo = TRUE, eval=TRUE, warning=FALSE, results='hide'}
sto_1 <- load_spatial("~/vizgen_input_region_1.txt")
sto_2 <- load_spatial("~/vizgen_input_region_0.txt")
```

## The STGrid object

```{r show, echo = TRUE, eval=TRUE, warning=FALSE, results='hide'}
sto_1
```
```{r}
summary(sto_1)
```

```{r slots, echo = TRUE, eval=TRUE, warning=FALSE, results='hide'}
slotNames(sto_1)
```

```{r show_methods, echo = TRUE, eval=TRUE, warning=FALSE, results='hide'}
stcompr::show_methods()
```

## Subsetting

### Using bin_x / bin_y

```{r binx_1, echo = TRUE, eval=TRUE, warning=FALSE, results='hide'}
head(bin_x(sto_1))
```

```{r binx_2, echo = TRUE, eval=TRUE, warning=FALSE, results='hide'}
head(bin_y(sto_1))
```

```{r binx_3, echo = TRUE, eval=TRUE, warning=FALSE, results='hide'}
sto_1[bin_x(sto_1)[50:100], ]
```

### Using features

```{r genes, echo = TRUE, eval=TRUE, warning=FALSE, results='hide'}
sto_1[c("Rag1", "Cd3e"), ]
```

Delete all Blanks...

```{r delete, echo = TRUE, eval=TRUE, warning=FALSE, results='hide'}
sto_1 <- rm_controls(sto_1)
sto_2 <- rm_controls(sto_2)
```

### Using numeric

According to the position in feat_names()

```{r blanks, echo = TRUE, eval=TRUE, warning=FALSE, results='hide'}
sto_1[feat_names(sto_1)[1:10], ]
```

The n-th feature...

```{r index, echo = TRUE, eval=TRUE, warning=FALSE, results='hide'}
nb_feat(sto_1)
sto_1[10:12, ]
```

# Image Visualization

Something about the `spatial_image()` function.

* Single feature

```{r single_feature, warning=FALSE, results='hide', echo = FALSE, eval=TRUE}
spatial_image(sto_1, feature="Rag1")
```
At higher res...

```{r}
spatial_image(re_bin(sto_1["Rag1"], bin_size = 10), feature="Rag1")
```

* sum of counts...

```{r sumcts, warning=FALSE, results='hide', echo = FALSE, eval=TRUE}
spatial_image(sto_1, feature="sum_of_cts", scale=FALSE)
```

## Zooming...

```{r}
sto_1_b5 <- re_bin(sto_1, bin_size=5)
```
Into endothelial cells

```{r}

spatial_image(sto_1_b5, 
             feature="sum_of_cts", 
             grid_by = 50)

sub <- sto_1_b5[bin_x(sto_1_b5)[350:550],
                          bin_y(sto_1_b5)[625:875]]

# Could also add Lifr, Ltbr
p1 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Selp", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Selp") + 
  theme(legend.position = "none")

p2 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "S100a6", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("S100a6") + 
  theme(legend.position = "none")

p3 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Dcn", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Dcn") + 
  theme(legend.position = "none")

p4 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Sparc", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Sparc") + 
  theme(legend.position = "none")

p5 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Pecam1", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Pecam1") + 
  theme(legend.position = "none")

p6 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Pdgfra", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Pdgfra") + 
  theme(legend.position = "none")


p7 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Cdh5", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Cdh5") + 
  theme(legend.position = "none")

p8 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Cd36", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Cd36") + 
  theme(legend.position = "none")

p9 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Ccl19", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Ccl19") + 
  theme(legend.position = "none")

p10 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Lifr", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Lifr") + 
  theme(legend.position = "none")

(p1 | p2 | p3 | p4 | p9) / (p5 | p6 | p7 | p8 | p10)


p1 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Cxcl12", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Cxcl12") + 
  theme(legend.position = "none")

p2 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Prss16", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Prss16") + 
  theme(legend.position = "none")

p3 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Ccl25", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Ccl25") + 
  theme(legend.position = "none")

p4 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Psmb11", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Psmb11") + 
  theme(legend.position = "none")

(p1 | p2) / (p3 | p4 )


p1 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Ccl22", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Ccl22") + 
  theme(legend.position = "none")

p2 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Krt14", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Krt14") + 
  theme(legend.position = "none")

p3 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Aire", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Aire") + 
  theme(legend.position = "none")

p4 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Fezf2", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Fezf2") + 
  theme(legend.position = "none")


p5 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Ccr7", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Ccr7") + 
  theme(legend.position = "none")

p6 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Igfbp4", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Igfbp4") + 
  theme(legend.position = "none")

(p1 | p2 | p3 ) / (p4 | p5 | p6)



```

```{r}
sto_2_b5 <- re_bin(sto_2, bin_size=5)

spatial_image(sto_2_b5, 
             feature="sum_of_cts", 
             overlay_feat = "Cd19", 
             grid_by = 50)

sub <- sto_2_b5[bin_x(sto_2_b5)[101:501],
                        bin_y(sto_2_b5)[101:851]]

# Could also add Lifr, Ltbr
p1 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Selp", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Selp") + 
  theme(legend.position = "none")

p2 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "S100a6", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("S100a6") + 
  theme(legend.position = "none")

p3 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Dcn", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Dcn") + 
  theme(legend.position = "none")

p4 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Sparc", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Sparc") + 
  theme(legend.position = "none")

p5 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Pecam1", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Pecam1") + 
  theme(legend.position = "none")

p6 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Pdgfra", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Pdgfra") + 
  theme(legend.position = "none")


p7 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Cdh5", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Cdh5") + 
  theme(legend.position = "none")

p8 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Cd36", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Cd36") + 
  theme(legend.position = "none")

p9 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Ccl19", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Ccl19") + 
  theme(legend.position = "none")

p10 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Lifr", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Lifr") + 
  theme(legend.position = "none")

(p1 | p2 | p3 | p4 | p9) / (p5 | p6 | p7 | p8 | p10)

p1 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Cxcl12", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Cxcl12") + 
  theme(legend.position = "none")

p2 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Prss16", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Prss16") + 
  theme(legend.position = "none")

p3 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Ccl25", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Ccl25") + 
  theme(legend.position = "none")

p4 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Psmb11", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Psmb11") + 
  theme(legend.position = "none")

(p1 | p2) / (p3 | p4 )


p1 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Ccl22", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Ccl22") + 
  theme(legend.position = "none")

p2 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Krt14", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Krt14") + 
  theme(legend.position = "none")

p3 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Aire", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Aire") + 
  theme(legend.position = "none")

p4 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Fezf2", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Fezf2") + 
  theme(legend.position = "none")


p5 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Ccr7", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Ccr7") + 
  theme(legend.position = "none")

p6 <-  spatial_image(sub, 
             feature="sum_of_cts", 
             overlay_feat = "Igfbp4", 
             colors_overlay = c("green", "red"), 
             size=0.3) + ggtitle("Igfbp4") + 
  theme(legend.position = "none")

(p1 | p2 | p3 ) / (p4 | p5 | p6)



```


## Comparing counts


```{r}
cmp <- stcompr(sto_1, sto_2, 
               name_1 = "young", name_2 = "old")
```


```{r}
cmp_volcano(cmp)
```



## Visualizing counts

### Barplot

```{r}
cmp_bar_plot(cmp, transform = "None", normalized = TRUE, features = c("Cd19", 
                                                                       "Mafb",
                                                                       "Ccl22",
                                                                       "Ccr7"))
```

### Boxplot

```{r}
cmp_boxplot(cmp, transform = "log10", normalized = TRUE)
```

# Density of molecules

## Ripley's K function

### Computing Ripley's K function

```{r}
sto_1 <- compute_k_ripley(sto_1)
sto_2 <- compute_k_ripley(sto_2)
```

```{r}
head(ripley_k_function(sto_1))
```

```{r}
plot_rip_k(sto_1) +  plot_rip_k(sto_2) 
```

### Comparing density across samples

```{r}
spatial_image(sto_1, feature="Cd36")
```
```{r}
cmp_images(sto_1, sto_2, feat_list=c("Ighd", "Cd19", "Spib", "Tbx21"), names = c("Young", "Aged"))
```


## Neighborhing changes

```{r}
heatmap_cmp(cmp, what ="changes", hclust_method = "single", filter=0.3)
```
```{r}
heatmap_cmp(cmp, what ="changes", only_feat = c("Ccl19", "Ccl25", "Rag1", "Dntt", "Pcna", "Mki67", "Ccl22", "Spib", "Cd19", "Ighd", "Cd3e", "Cd3d", "Ccr6", "Dcn", "Ccr9", "Cxcl12", "Aire", "fezf2", "Krt14", "H2-Aa", "S1pr1"), hclust_method = "single")
```

## UMAP

```{r}
um <- umap(as.matrix(cmp@neighborhood_changes))
um <- um$layout
colnames(um) <- c("x", "y")
ggplot(as.data.frame(um), aes(x=x, y=y, label=rownames(um))) + geom_point() + ggrepel::geom_text_repel(size=1)
```

## Session info

```{r}
sessionInfo()
```

