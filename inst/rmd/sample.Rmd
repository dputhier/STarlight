---
params:
  all: null
---

```{r panel_setup_final, include = FALSE}
xaringanExtra::use_panelset()
xaringanExtra::style_panelset(font_family = "inherit")
xaringanExtra::style_panelset_tabs(foreground = "honeydew", background = "seagreen")
```


PANELSET_CODE

```{r start, include=FALSE, echo=FALSE, eval=TRUE}

STarlight::set_verb_level(0)
library(knitr)
options(width=400)

knitr::opts_chunk$set(
  fig.path=params$all$fig_path,
  fig.align = "center", 
  size = "tiny", 
  comment = "",
  fig.dpi=300,
  out.width="100%"
)

```


```{r setparams, include=FALSE, echo=FALSE, eval=TRUE}

this_params <- params$all
spatial_image_params <- this_params$spatial_image
params_hc <- this_params$hc_tree_params
cmp_counts_st_params <- this_params$cmp_counts_st_params
st_grid <- this_params$st_grid
fig_h <- round(STarlight::nb_feat(st_grid)/7, 0) + 2
fig_h <- ifelse(fig_h < 1, 1.5, fig_h)
```


# Sample `r this_params$sample_name`

This section provides a general overview of the STGrid object representing the sample. Details such as feature count, grid dimensions, and spatial bin configurations are presented. 



## General information  


### STGrid object info 

```{r information, echo=FALSE, eval=TRUE }

t1 <- rbind(c("type:", class(st_grid)),
            c("Nb_feature:", STarlight::nb_feat(st_grid)),
            c("Number of counts:", STarlight::nb_items(st_grid)),
            c("Bin size:", STarlight::bin_size(st_grid)),
            c("Number of bins (x axis):", STarlight::nbin_x(st_grid)),
            c("Number of bins (y axis):", STarlight::nbin_y(st_grid))
            )

t2 <- rbind(c("Min value (x axis):", st_grid@x_min),
            c("Max value (x axis):", st_grid@x_max),
            c("Min value (y axis):", st_grid@y_min),
            c("Max value (y axis):", st_grid@y_max))

knitr::kable(t1) %>% kableExtra::column_spec(1, bold = TRUE) %>% 
  kableExtra::kable_styling(full_width = FALSE, position = "float_left")
knitr::kable(t2) %>% kableExtra::column_spec(1, bold = TRUE) %>% 
  kableExtra::kable_styling(full_width = FALSE, position = "left")
```


## Feature counts {.panelset}

This section presents the feature counts of the sample of interest. It includes a count table and barplot summarizing the number of occurrences for each feature.


### Count table 

```{r count_table, echo=FALSE, eval=TRUE}
counts <- as.data.frame(STarlight::table_st(st_grid))
colnames(counts) <- c("Feature", "Counts")
DT::datatable(as.data.frame(counts))
```


### Count barplot

```{r cmp_counts_st, echo=FALSE, eval=TRUE, fig.height=round(fig_h, 0) * 0.5 + 1, fig.width=7}

this_params$cmp_counts_st_params$st_grid <- st_grid
this_params$cmp_counts_st_params$features <- STarlight::feat_names(st_grid)

do.call(eval(parse(text="STarlight::cmp_counts_st")), 
        this_params$cmp_counts_st_params) + ggplot2::coord_flip()

```


## Feature spatial density {.panelset}

This section explores the spatial distribution of each feature across the area. By analyzing the density patterns of each feature, we can identify areas of higher or lower feature concentration. These insights help reveal underlying spatial homogeneity or heterogeneity.



### Moran's Index

```{r moran_i, echo=FALSE, eval=TRUE, fig.height=5, fig.width=7}
STarlight::set_verb_level(0)
st_grid <- STarlight::compute_moran_index(st_grid)
STarlight::plot_moran_i(st_grid)
```

### K function

This section contains the result of K Ripley's function to evaluate molecule density. 

```{r ripley, echo=FALSE, eval=TRUE}

STarlight::set_verb_level(0)
st_grid <- STarlight::compute_k_ripley(st_grid, verbose=FALSE)
this_params$plot_rip_k_params$object <- st_grid
do.call(eval(parse(text="STarlight::plot_rip_k")), 
        this_params$plot_rip_k_params) 
```

```{r ripley_by_gene, echo=FALSE, eval=TRUE, fig.height=round(length(STarlight::feat_names(st_grid))/this_params$plot_rip_k_params$ncol, 0) * 1.5 + 1, fig.width=7 }

this_params$plot_rip_k_params$feature <- STarlight::feat_names(st_grid)
do.call(eval(parse(text="STarlight::plot_rip_k")), 
        this_params$plot_rip_k_params) 
```

### L function

This section contains the result of the normalized K Ripley's function (L) to evaluate molecule density.

```{r ripley_l, echo=FALSE, eval=TRUE}

STarlight::set_verb_level(0)
st_grid <- STarlight::compute_k_ripley(st_grid, 
                                       method="L", verbose=FALSE)
this_params$plot_rip_k_params$object <- st_grid
this_params$plot_rip_k_params$feature <- NULL
do.call(eval(parse(text="STarlight::plot_rip_k")), 
        this_params$plot_rip_k_params) 

```

```{r ripley_l_by_gene, echo=FALSE, eval=TRUE, fig.height=round(length(STarlight::feat_names(st_grid))/this_params$plot_rip_k_params$ncol, 0) * 1.5 + 1, fig.width=7}

this_params$plot_rip_k_params$object <- st_grid
this_params$plot_rip_k_params$feature <- STarlight::feat_names(st_grid)
do.call(eval(parse(text="STarlight::plot_rip_k")), 
        this_params$plot_rip_k_params) 

```


## Feature correlations {.panelset}

In this section, feature correlations are analyzed to uncover relationships between different features. By calculating and visualizing these correlations, we gain a deeper understanding of how features co-vary across the space.


```{r prepare_hc, echo=FALSE, eval=TRUE}

this_params$hc_tree_params$object <- st_grid
this_params$hc_tree_params$return_list <- TRUE
hc <- do.call(eval(parse(text="STarlight::hc_tree")),
              this_params$hc_tree_params)

cor_mat <- hc$cor_mat[hc$hc_clust$order, hc$hc_clust$order]

```


### Correlations

This subsection delves into the correlations among selected features within the sample. By examining the pairwise relationships, we can identify strong positive or negative correlations, which may indicate underlying biological or spatial interactions.

```{r corrplot, echo=FALSE, eval=TRUE, fig.width=7}

corrplot::corrplot(cor_mat, type="upper", order="original",
                   col=RColorBrewer::brewer.pal(n=8, name="RdYlBu"),
                   tl.cex=this_params$corrplot_text_size, diag = FALSE)

```

### Tree

This subsection presents a hierarchical clustering tree (or dendrogram) to visualize the relationships among features based on their similarity. The tree structure allows us to see clusters of closely related features, offering insights into groups that share similar spatial or quantitative characteristics.

```{r display_tree, echo=FALSE, eval=TRUE}

print(hc$p + Seurat::NoLegend()) 
```

### Modules 

Modules represent clusters of features that exhibit similar spatial patterns or functional relationships, providing a modular perspective on the dataset.

```{r modules, echo=FALSE, eval=TRUE}

st_grid <- STarlight::compute_module_score(st_grid, 
                                          modules = hc$tree_classes)
mn <- STarlight::meta_names(st_grid)


this_params$spatial_image_params$features <- mn[grep("MOD[0-9]+", mn, perl = TRUE)]
this_params$spatial_image_params$object <- st_grid

do.call(eval(parse(text="STarlight::spatial_image")), 
        this_params$spatial_image_params) + ggplot2::coord_fixed()


```

### Modules info

```{r module_info, echo=FALSE, eval=TRUE}

mod_info <- reshape2::melt(hc$tree_classes)
colnames(mod_info) <- c("Feature", "Module")
DT::datatable(mod_info)
```


## Spatial distribution {.panelset}

This section investigates the spatial arrangement of features across the sample, offering insights into how features are distributed within the spatial grid. 



### Rasterized images of features

This subsection presents rasterized images of individual features, translating spatial data into binned representations.

```{r Rasterized_images_of_features, echo=FALSE, eval=TRUE, fig.align='center', fig.pos='top', fig.width=5, fig.height=((st_grid@y_max - st_grid@y_min)  * 10) / ((st_grid@x_max - st_grid@x_min) * 4) * 5.5 * this_params$image_height + 1}

this_params$spatial_image_params$object <- st_grid
this_params$spatial_image_params$features <- STarlight::feat_names(st_grid)
do.call(eval(parse(text="STarlight::spatial_image")), 
        this_params$spatial_image_params) 

```

### Spatial distribution of counts

This subsection examines the spatial distribution of the sum of feature counts across binned region of the sample. 


```{r Spatial_distribution_of_counts, echo=FALSE, eval=TRUE, fig.width=5, fig.align='center'}
knitr::opts_chunk$set(out.width="25%")
STarlight::spatial_image(object = st_grid, 
          features = "count_sum")
```


<!-- Ensure the style is taken into account across all the samples -->

<style>
.panelset .panel-active {
    display: block !important;
}
</style>


